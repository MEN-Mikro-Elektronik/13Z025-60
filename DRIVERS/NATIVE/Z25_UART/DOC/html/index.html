<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - 13z025-60 - Main Page</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">13z025-60 &nbsp; </h1>
	<h3>Main Page</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindexHL" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>13z025-60 Documentation</h1>
<p>
<br>
 The Z25 VxWorks driver is a generic uart driver for the MEN FPGA uart cores 16Z025/16Z125 and 16Z057. The driver scans the PCI bus and searches for 16Z025/16Z125 and 16Z057 chameleon devices.<br>
<p>
The driver can start automatically at system boot or can be started manually after the boot procedure. If initialization at system boot is desired, the driver initialization functions must be called in <em>sysSerialHwInit2 (sysSerial.c)</em>.<br>
 <br>
 The 13Z025-60.zip file contains all files and scripts to install the driver. <br>
 <br>
 <h2><a name="CHAP_00"></a>
Hardware Requirements</h2>
The driver requires the following hardware:<br>
<ul>
<li>x86 or PowerPC architecture, e.g. D3 or EM7<br>
</li><li>F206 with <em>F206-00IC001B2.rbf</em> FPGA filling<br>
</li><li>SA-Adapter, e.g.:<br>
 08SA01-00: rs232<br>
 08SA02-00: RS485 half duplex<br>
 08SA02-01: RS485 full duplex<br>
 <br>
 </li></ul>
<h2><a name="CHAP_01"></a>
Software Requirements</h2>
The software requires:<br>
<ul>
<li>Tornado2.2 / VxWorks 5.5<br>
</li><li>Wind River Workbench 2.x / VxWorkts 6.x<br>
 <br>
 </li></ul>
<h2><a name="CHAP_02"></a>
Supported Devices</h2>
The following devices are supportedt by the 13Z025-60 driver:<br>
<p>
<ul>
<li>15EM01</li><li>15EM03</li><li>15EM04 (define Z25_USE_CHAMELEON_IRQ in Makefile)</li><li>15EM05</li><li>15EM07</li><li>02F206</li><li>02F206i</li><li>02F206n01</li><li>02D006-00 <br>
 </li></ul>
<h2><a name="CHAP_1"></a>
1. Feature List</h2>
This section describes the basic features of the Z25 driver.<br>
<ul>
<li>Z025: Baudrates from 300 upto 115200 baud<br>
 Z125: Baudrates from 110 upto 30000000 baud<br>
</li><li>Stop bits 1 or 2<br>
</li><li>Data bits 5 ... 8<br>
</li><li>Parity even, odd or no<br>
</li><li>Automatic Xon/Xoff<br>
</li><li>Manual hardware handshake<br>
</li><li>Automatic RTS/CTS handshake (Z125 only!)<br>
</li><li>VxWorks TTY conformity<br>
</li><li>Can be integrated into any board support packages (BSP)<br>
</li><li>Can be integrated in MDIS environment<br>
</li><li>Driver channels can be used as serial console at boot<br>
</li><li>Each PCI device can be installed separately via its PCI bus path<br>
</li><li>User-definable interrupt functions<br>
</li><li>Possibility to activate debug output<br>
 <br>
 </li></ul>
<h2><a name="CHAP_2"></a>
2. Short Description</h2>
The 13Z025 driver consists of a high-level and a low-level interface. The low-level interface is provided by the module <em>mz25_modules.c</em>. This module defines all 16Z025/16Z125 and 16Z057 specific functions and controls. It is used by the main module <em><a class="el" href="z25__driver_8c.html">z25_driver.c</a></em>. <br>
 A third module <em><a class="el" href="z25__mdis_8c.html">z25_mdis.c</a></em> is provided for integrating the native driver into MDIS.<br>
 <br>
<p>
Header file <em>Z25_driver.h</em> includes various defines which allow the user to adapt the driver to the system.<br>
 <br>
<ul>
<li><b>Z25_MAX_PCI_DEV</b>:<br>
 Limit maximum number of supported PCI devices<br>
 <em><b>Default value:</b> 10</em><br>
 <br>
</li><li><b>Z25_MAX_UNITS</b>: <br>
 Maximum number of supported UART units per Chameleon device if initialization in BSP it represents the total number of UART units in the system<br>
 <em><b>Default value:</b> 10</em><br>
 <br>
</li><li><b>Z25_RX_BUFF_SIZE / Z25_TX_BUFF_SIZE</b>: <br>
 Receive/send buffer size for each UART channel<br>
 <em><b>Default value:</b> 512</em><br>
 <br>
 </li></ul>
<h3><a name="CHAP_21"></a>
Supported I/O Controls</h3>
All supported I/O controls return OK on success or ERROR if the operation failed. The following gives a list of all driver controls.<br>
 <b>13Z025 specific controls:</b><br>
<ul>
<li>MEN_UART_IOCTL_DATABITS<br>
 Set data bits, <em>value=5..8</em><br>
</li><li>MEN_UART_IOCTL_PARITY<br>
 Set parity, <em>value=0(no),1(even) or 2(odd)</em><br>
</li><li>MEN_UART_IOCTL_STOPBITS<br>
 Set stop bits, <em>value=1 or 2</em><br>
</li><li>MEN_UART_IOCTL_SET_RTS<br>
 Set RTS line, <em>value=0(RTS low) or 1(RTS high)</em><br>
</li><li>MEN_UART_IOCTL_SET_DTR<br>
 Set DTR line, <em>value=0(DTR low) or 1(DTR high)</em><br>
</li><li>MEN_UART_IOCTL_SET_OUT1<br>
 Set OUT1 line, <em>value=0(OUT1 low) or 1(OUT1 high)</em><br>
</li><li>MEN_UART_IOCTL_SET_OUT2<br>
 Set OUT2 line, <em>value=0(OUT2 low) or 1(OUT2 high)</em><br>
</li><li>MEN_UART_IOCTL_GET_CTS<br>
 Get CTS status, <em>return value is 1 if CTS is set, otherwise 0 if not set</em><br>
</li><li>MEN_UART_IOCTL_GET_DSR<br>
 Get DSR status, <em>return value is 1 if DSR is set, otherwise 0 if not </em> set<br>
</li><li>MEN_UART_IOCTL_GET_DCD<br>
 Get DCD status, <em>return value is 1 if DCD is set, otherwise 0 if not </em> set<br>
</li><li>MEN_UART_IOCTL_MODE_SELECT<br>
 Set physical mode, <em>value=0(RS232), 1(RS485 half duplex), 2(RS485 full duplex)</em><br>
</li><li>MEN_UART_IOCTL_AUTO_RS485<br>
 Set automatic RS485 2-wire mode, <em>value=ignored</em><br>
</li><li>MEN_UART_IOCTL_MODE_GET<br>
 Get physical mode, <em>return value=0(RS232), 1(RS485 half duplex), 2(RS485 full duplex)</em><br>
</li><li>MEN_UART_IOCTL_MODEM<br>
 Set modem modes, <em>value=1(activate) or 0(deactivate)</em><br>
</li><li>MEN_UART_IOCTL_SET_FIFO_BYTES<br>
 Set Rx FIFO trigger level of uart. Z025: 1/4/30/58 bytes, <em>value=1/4/30/58</em><br>
 Z125: 1/8/30/116 bytes, <em>value=1/8/60/116</em><br>
</li><li>MEN_UART_IOCTL_SET_TX_FIFO_BYTES<br>
 Set Tx FIFO trigger level of uart. Z025: up to 60 bytes, <em>value=1..60</em><br>
 Z125: up to 116 bytes, <em>value=1..116</em><br>
 <b>Standard VxWorks controls:</b><br>
</li><li>SIO_BAUD_SET, <em>value=decimal baud-rate value, e.g. 9600</em><br>
</li><li>FIOBAUDRATE, <em>value=decimal baud-rate value, e.g. 9600</em><br>
</li><li>SIO_BAUD_GET, <em>return is decimal baud-rate value, e.g. 9600</em><br>
</li><li>SIO_HW_OPTS_SET, <em>set the hardware options</em><br>
</li><li>SIO_HW_OPTS_GET, <em>get the hardware options</em><br>
</li><li>SIO_MSTAT_GET, <em>returns status of all input and output modem signals</em><br>
</li><li>SIO_MCTRL_BITS_SET, <em>sets modem signal(s) specified in argument</em><br>
</li><li>SIO_MCTRL_BITS_CLR, <em>clears modem signal(s) specified in argument</em><br>
</li><li>SIO_MCTRL_OSIG_MASK, <em>returns mask of all input modem signals</em><br>
</li><li>SIO_MCTRL_ISIG_MASK, <em>returns mask of all output(writable) modem signals</em><br>
 <br>
 </li></ul>
<h3><a name="CHAP_22"></a>
Supported System Calls</h3>
<ul>
<li><em><b>open(name, mode, 0):</b></em> open a device (create a handle to the device)<br>
 e.g.: open("/tyZ25_00/0", 2, 0)<br>
</li><li><em><b>read(fd, ,data, bytes):</b></em> read data from the device<br>
 e.g.: read( fd , &amp;buffer, size )</li><li><em><b>write(fd, data, bytes):</b></em> write data to the device<br>
 e.g.: write(fd, &amp;buffer, size)<br>
</li><li><em><b>ioctl(fd, request, value):</b></em> configure the device<br>
 see <em>Supported I/O Controls</em><br>
 e.g.: ioctl (fd , FIOBAUDRATE, 19200)<br>
</li><li><em><b>close (fd):</b></em> close the device (delete the handle to the device)<br>
 e.g.: close (fd)<br>
</li></ul>
<p>
fd: file descriptor returned by <em>open</em> function<p>
<br>
 <h2><a name="CHAP_3"></a>
3. Driver Make</h2>
This section describes how the driver can be built.<br>
 <br>
 <h3><a name="CHAP_31"></a>
3.1 Related Files</h3>
This section gives an overview about the driver files. <br>
 <h4><a name="CHAP_311"></a>
3.1.1 High-Level Files</h4>
<ul>
<li><em><a class="el" href="z25__driver_8c.html">z25_driver.c</a></em><br>
 Z25 driver source file<br>
</li><li><em><a class="el" href="z25__driver_8h.html">z25_driver.h</a></em><br>
 Z25 driver header file<br>
</li><li><em><a class="el" href="z25__driver__int_8h.html">z25_driver_int.h</a></em><br>
 Z25 driver internal header file <br>
 </li></ul>
<h4><a name="CHAP_312"></a>
3.1.2 Low-Level Files</h4>
<ul>
<li><em><a class="el" href="mz25__module_8c.html">mz25_module.c</a></em><br>
 13Z025 low level source file<br>
</li><li><em><a class="el" href="mz25__module_8h.html">mz25_module.h</a></em><br>
 13Z025 low level header file<br>
</li><li><em><a class="el" href="mz25__module__int_8h.html">mz25_module_int.h</a></em><br>
 13Z025 low level internal header file <br>
 </li></ul>
<h4><a name="CHAP_313"></a>
3.1.3 MDIS Files</h4>
<ul>
<li><em><a class="el" href="z25__mdis_8c.html">z25_mdis.c</a></em><br>
 13Z025 mdis source file<br>
</li><li><em><a class="el" href="z25__mdis_8h.html">z25_mdis.h</a></em><br>
 13Z025 mdis header file<br>
 <br>
 </li></ul>
<h4><a name="CHAP_314"></a>
3.1.4 Scripts</h4>
<ul>
<li><em>driver.mak</em> <br>
 MDIS makefile, links driver functions to <em>mdis_xxx.o</em><br>
</li><li><em>driver_sw.mak</em> <br>
 MDIS makefile with byteswap, links driver functions to <em>mdis_xxx.o</em><br>
</li><li><em>makef.mak</em> <br>
 Module makefile, generates objects <em>mz25_module.o</em>, <em>z25_driver.o</em> and <em>z25.o</em><br>
</li><li><em>mk.bat</em> <br>
 Batch file to make objects with makefile <em>makef.mak</em><br>
 <br>
 </li></ul>
<h3><a name="CHAP_32"></a>
3.2 MDIS Integration</h3>
To integrate the driver into MDIS refer to document <em>21m000-14.pdf</em> (MDIS4 under VxWorks) chapters A2, A3 and A4.<br>
 <br>
 <h3><a name="CHAP_33"></a>
3.3 Compile</h3>
To compile the driver it is neccessary to set the environment variables of the host to the Tornado path, similar to compilation of a VxWorks BSP or other drivers.<br>
 If the compile procedure succeeded the objects are placed in the following directory for a PPC603 architecture:<br>
 <div class="fragment"><pre>
          /VXWORKS/LIB/MEN/objppc603gnu
                        or:
          /VXWORKS/LIB/MEN/objppc603&gt;gnutest </pre></div><h4><a name="CHAP_331"></a>
3.3.1 MDIS</h4>
To integrate the 13Z025 driver into MDIS, perform the following steps:<br>
<ul>
<li>Start the mdiswizard.<br>
</li><li>Create a new MDIS project.<br>
</li><li>Select the desired CPU board.<br>
</li><li>Install <em>13Z025-60.zip</em> driver package.<br>
</li><li>Add an F206 CompactPCI 3U FPGA carrier board.<br>
</li><li>Add the Z25 driver units to FPGA internal slot 0..15.<br>
</li><li>Save and build the projects.<br>
</li></ul>
<p>
You can find a detailed description of how to use the MDIS Wizard in the MDIS user manual, see Chapter 3.2 MDIS Integration.<br>
 <br>
 <h4><a name="CHAP_332"></a>
3.3.2 None-MDIS</h4>
In order to use the Z25 driver on different platforms the <em>mk.bat</em> must be modfied to fit the desired CPU type. Only one CPU type can be activated, the others must remain deactivated. If you wish to compile the driver for debug purposes comment the respective lines in <em>mk.bat</em>.<br>
 <h2><a name="CHAP_4"></a>
4. Driver Usage</h2>
The driver can be installed in two ways. First it can be installed using <em>Z25_MdisDriver</em> and second via <em>Z25_CreateDevice</em>. The first function initializes the device via the MDIS board and device descriptors, where all necessary information is stored. The second possibility needs a few more parameters as input (see 4.3 VxWorks Shell).<br>
 If debug output is enabled, the debug message can be displayed through <em> DBG_Show()</em>.<br>
 <dl compact><dt><b>Note:</b></dt><dd>For some processor boards it is neccessary to change the UART clock frequency. In this casy you can use the function <em>Z25_SetUartBase </em> to change the frequency. For detailed information about this frequency read the user manual of the processor board. <br>
 </dd></dl>
<h3><a name="CHAP_41"></a>
4.1 PCI Bus Path</h3>
The PCI device path is an enumeration of PCI device numbers of the PCI bridges which will be used on the way to the desired module.<br>
 <b>Example:</b><br>
 The system consists of a D3 CPU board with an F206. The D3 is placed in slot 1 of the CompactPCI backplane. The first F206 is placed in slot 2 of the CompactPCI backplane. The PCI device path for this F206 would be "0x1E 0x0F", because:<br>
<ul>
<li>0x1E is the device number of the PCI bridge for the CompactPCI backplane on the D3.<br>
</li><li>0x0F is the device number of the F206 in slot 2 of the CompactPCI backplane.<br>
 <br>
 </li></ul>
<h3><a name="CHAP_42"></a>
4.2 MDIS</h3>
After loading the MDIS object the following function must be called to initialize the driver properly.<br>
 <br>
 OS2M_DrvInstall <br>
 OSS_SetIrqNum0 0 <br>
 Z25_MdisDriver(&amp;f206_1, &amp;z25_1)<br>
<ul>
<li>f206_1: board descriptor of first F206<br>
</li><li>z25_1: device descriptor of first 16Z025 quad UART unit<br>
</li><li>OSS_SetIrqNum0: 0 for power pc boards and 0x20 for intel boards</li></ul>
<p>
<br>
 <dl compact><dt><b>Note:</b></dt><dd>Only one 16Z025 quad UART unit of the FPGA will be installed ! <br>
</dd></dl>
The device list with your 16Z025/16Z125 and 16Z057 UART channels should appear, if you enter the command <em>devs</em> in the VxWorks shell:<br>
 <div class="fragment"><pre>
        -&gt; devs
        drv name
          0 /null
          1 /tyCo/0
          1 /tyCo/1
          1 /tyCo/2
          1 /tyCo/3
          6 host:
         10 /vio
         11 /tgtsvr
         12 /tyZ25_00/0
         12 /tyZ25_00/1
         12 /tyZ25_00/2
         12 /tyZ25_00/3
</pre></div><br>
 <h3><a name="CHAP_43"></a>
4.3 VxWorks Shell</h3>
To initialize the driver in the VxWorks shell after boot the two object files <em>z25.o</em> must be loaded. After that the driver can be installed using the following function call:<br>
 <br>
 Z25_CreateDevice("/tyZ25_0", "0x1E 0x0F", 1, 0x00, 0x80, 1843200, intConnect, intEnable)<br>
<p>
<ul>
<li>"/tyZ25_0" : device name<br>
</li><li>"0x1E 0x0F" : PCI bus path<br>
</li><li>0x00 : interrupt vector base (intel =&gt; 0x20)<br>
</li><li>0x80 : chameleon V2 interrupt offset (BSP specific)</li><li>1843200 : uart base freqency, if 0 DOS compatibility mode (1.8432MHz)</li><li>intConnect: interrupt connect function, if zero <em>pciIntConnect</em> is used as default<br>
</li><li>intEnable : interrupt enable function, if zero <em>intEnable</em> is used as default<br>
</li></ul>
<p>
<br>
 <dl compact><dt><b>Note:</b></dt><dd>All 16Z025 quad UART units of the FPGA will be installed ! As default the uarts are configured for use in DOS compatibility mode. If it is required to change the uart frequency, please use the function 'Z25_SetBaseBaud'. <br>
</dd></dl>
The device list with your 16Z025/16Z125 and 16Z057 UART channels should appear, if you enter the command <em>devs</em> in the VxWorks shell:<br>
 <div class="fragment"><pre>
        -&gt; devs
        drv name
          0 /null
          1 /tyCo/0
          1 /tyCo/1
          1 /tyCo/2
          1 /tyCo/3
          6 host:
         10 /vio
         11 /tgtsvr
         12 /tyZ25_00/0
         12 /tyZ25_00/1
         12 /tyZ25_00/2
         12 /tyZ25_00/3
         13 /tyZ25_01/0
         13 /tyZ25_01/1
         13 /tyZ25_01/2
         13 /tyZ25_01/3
</pre></div><br>
 <h3><a name="CHAP_44"></a>
4.4 Board Support Package (BSP)</h3>
To integrate the driver in a BSP the driver objects must be linked to the VxWorks image file. Only the function <em>sysSerialHwInit2</em> must be adapted for the integration. The following code section shows a typical driver initialization at boot time.<br>
 <div class="fragment"><pre><span class="preprocessor">  #include "<a class="code" href="z25__driver_8h.html">MEN/z25_driver.h</a>"</span>

  <span class="keywordtype">void</span> sysSerialHwInit2 (<span class="keywordtype">void</span>)
  {
      u_int16 i;
      u_int16 j, k;
      u_int16 unit = 0;
      u_int16 maxUnit = 0;
      <a class="code" href="structZ25__DEV__TS.html">Z25_DEV_TS</a> *z25DevP;

      -- Initialize driver resources
      <span class="keywordflow">if</span>( (z25DevP = <a class="code" href="group____Z25__GLOB__FUNC.html#a4">Z25_InitDriver</a>()) != NULL )
      {
           -- BSP specific offset <span class="keywordflow">for</span> chameleon v2 devices
           z25DevP-&gt;usePciIrq = 0; -- <span class="keywordflow">if</span> PCI interrupt is connected, set usePciIrq = 1
           z25DevP-&gt;irqOffset = BSP_CHAMELEON_V2_IRQ_OFFSET;

           -- Set interrupt functions
           <a class="code" href="group____Z25__GLOB__FUNC.html#a2">Z25_SetIntFunctions</a>(z25DevP, 0, intConnect, intEnable);
           -- Find all quad UART units in the system
           <span class="keywordflow">for</span>( i=0; i&lt;z25DevP-&gt;noPciPaths; i++ )
           {
               <span class="keywordflow">if</span>( <a class="code" href="group____Z25__GLOB__FUNC.html#a1">Z25_FindUartUnits</a>(z25DevP, i, &amp;unit, &amp;maxUnit) != 0 )
               {
                   i = z25DevP-&gt;noPciPaths;
                   maxUnit = 0;
               }
           }
           -- Install all quad UART units
           <span class="keywordflow">for</span>( j=0; j&lt;z25DevP-&gt;no16Z25Dev; j++ )
           {
               <span class="keywordflow">for</span>( k=0; k&lt;<a class="code" href="z25__driver_8h.html#a7">Z25_MAX_UARTS_PER_DEV</a>; k++ )
               {
                    <a class="code" href="group____Z25__GLOB__FUNC.html#a6">Z25_InitDriverAtBoot</a>(z25DevP, j, k);

                   addSioChanEntry( tyCoNum++,
                     (SIO_CHAN *)&amp;z25DevP-&gt;quadUart[j][k].u.sioT.pDrvFuncs );
               }

               -- set the UART frequency <span class="keywordflow">for</span> the 15EM01-00
               -- please read the user manual <span class="keywordflow">for</span> detailed information
               <a class="code" href="group____Z25__GLOB__FUNC.html#a3">Z25_SetBaseBaud</a>(z25DevP, 132571429, j);
           }
      }
  }
</pre></div><br>
 
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for 13z025-60 using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2014 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

